<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>單線鼓譜編輯器</title>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --primary: #10b981;
            --accent: #f43f5e;
            --secondary: #fbbf24;
            --text: #f8fafc;
            --grid-bg: #111827;
            --dot-empty: #334155;
        }
        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            -webkit-user-select: none; user-select: none;
        }

        /* 頂部控制列 */
        .controls {
            padding: 15px; background: var(--panel);
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); z-index: 20;
        }
        .card { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .label { font-size: 0.75rem; color: #94a3b8; margin-bottom: 5px; }
        .bpm-val { font-size: 2rem; font-weight: 800; color: var(--primary); line-height: 1; }
        input[type=range] { width: 100%; max-width: 150px; accent-color: var(--primary); }
        select {
            padding: 8px 12px; border-radius: 8px; background: #334155; color: white;
            border: 1px solid #475569; font-size: 0.9rem; cursor: pointer; width: 100%;
        }

        /* 編輯區域 */
        .main-editor {
            flex-grow: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px;
        }
        .sequencer-grid {
            display: grid; grid-template-columns: repeat(8, 1fr);
            gap: 12px; width: 100%; max-width: 800px;
            padding: 25px; background: var(--grid-bg); border-radius: 20px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }
        @media (min-width: 600px) {
            .sequencer-grid { grid-template-columns: repeat(16, 1fr); }
        }

        /* 格點樣式 */
        .step {
            aspect-ratio: 1/1; border-radius: 50%; background: var(--dot-empty);
            cursor: pointer; position: relative; transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; justify-content: center;
            border: 2px solid transparent;
        }
        .step::after { content: ""; border-radius: 50%; transition: all 0.1s; }

        /* 重音：紅色大圓 */
        .step.strong { background: var(--accent); transform: scale(1.1); box-shadow: 0 0 15px rgba(244, 63, 94, 0.4); }
        /* 弱音：黃色小圓 */
        .step.weak { background: var(--dot-empty); border: 2px solid var(--secondary); }
        .step.weak::after { width: 40%; height: 40%; background: var(--secondary); box-shadow: 0 0 8px var(--secondary); }
        
        /* 播放中的高亮 */
        .step.playing { border-color: white; transform: scale(1.2); z-index: 5; box-shadow: 0 0 20px white; }

        /* 底部按鈕 */
        .footer { padding: 30px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        button#playBtn {
            padding: 16px 60px; font-size: 1.25rem; font-weight: bold;
            border-radius: 50px; border: none; cursor: pointer;
            background: var(--primary); color: white; transition: all 0.2s;
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }
        button#playBtn.stop { background: var(--accent); box-shadow: 0 10px 20px rgba(244, 63, 94, 0.3); }
        .help-text { font-size: 0.85rem; color: #64748b; text-align: center; line-height: 1.5; }

        /* 分隔線提示 */
        .step:nth-child(4n):not(:last-child) { position: relative; }
        .step:nth-child(4n):not(:last-child)::before {
            content: ""; position: absolute; right: -8px; top: 10%; bottom: 10%;
            width: 2px; background: rgba(255,255,255,0.05);
        }
    </style>
</head>
<body>

    <div class="controls">
        <div class="card">
            <span class="bpm-val" id="bpmText">120</span>
            <input type="range" id="bpmSlider" min="40" max="220" value="120">
            <span class="label">BPM 速度</span>
        </div>
        
        <div class="card">
            <select id="soundType">
                <option value="taiko" selected>和太鼓 (Taiko)</option>
                <option value="woodblock">清脆木魚 (Wood)</option>
                <option value="electronic">電子合成 (Synth)</option>
            </select>
            <span class="label">音色設定</span>
        </div>

        <div class="card">
            <button style="background:none; border:1px solid #475569; color:#94a3b8; padding:5px 15px; border-radius:5px; cursor:pointer; font-size:0.8rem;" id="clearBtn">重置譜面</button>
            <span class="label">工具</span>
        </div>
    </div>

    <div class="main-editor">
        <div class="sequencer-grid" id="grid">
            <!-- 16個步進格點由 JS 生成 -->
        </div>
        
        <div class="footer">
            <button id="playBtn">播放練習</button>
            <div class="help-text">
                點擊格點循環切換狀態：<br>
                灰色 (休止) → <span style="color:var(--accent)">紅色 (重擊 Don)</span> → <span style="color:var(--secondary)">黃色 (弱擊 Ka)</span>
            </div>
        </div>
    </div>

    <script>
        // --- 高精度 Web Worker 定時器 ---
        const workerCode = `
            let timerID = null;
            self.onmessage = (e) => {
                if (e.data === "start") {
                    timerID = setInterval(() => postMessage("tick"), 25);
                } else if (e.data === "stop") {
                    clearInterval(timerID);
                    timerID = null;
                }
            };
        `;
        const timerWorker = new Worker(URL.createObjectURL(new Blob([workerCode])));

        let audioCtx = null;
        let isPlaying = false;
        let bpm = 120;
        let currentStep = 0;
        let nextNoteTime = 0.0;
        const scheduleAheadTime = 0.1;
        
        // 儲存 16 格狀態 (0:休止, 1:強, 2:弱)
        const scoreData = new Array(16).fill(0);

        const gridEl = document.getElementById('grid');
        const playBtn = document.getElementById('playBtn');
        const bpmSlider = document.getElementById('bpmSlider');
        const bpmText = document.getElementById('bpmText');
        const soundTypeEl = document.getElementById('soundType');
        const clearBtn = document.getElementById('clearBtn');

        // 初始化格點介面
        function initGrid() {
            gridEl.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const step = document.createElement('div');
                step.className = 'step';
                step.dataset.index = i;
                step.onclick = () => {
                    scoreData[i] = (scoreData[i] + 1) % 3;
                    renderStep(step, scoreData[i]);
                };
                gridEl.appendChild(step);
            }
        }

        function renderStep(el, state) {
            el.classList.remove('strong', 'weak');
            if (state === 1) el.classList.add('strong');
            else if (state === 2) el.classList.add('weak');
        }

        // 音頻合成器
        function playSynth(time, state) {
            if (state === 0) return;
            const sound = soundTypeEl.value;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            let freq = 440;
            let decay = 0.1;

            if (sound === 'taiko') {
                freq = state === 1 ? 70 : 120;
                osc.frequency.setValueAtTime(freq, time);
                osc.frequency.exponentialRampToValueAtTime(freq * 0.5, time + 0.15);
                decay = 0.2;
            } else if (sound === 'woodblock') {
                freq = state === 1 ? 1000 : 1500;
                osc.frequency.setValueAtTime(freq, time);
                decay = 0.05;
            } else {
                freq = state === 1 ? 800 : 400;
                osc.frequency.setValueAtTime(freq, time);
                decay = 0.08;
            }

            gain.gain.setValueAtTime(state === 1 ? 0.5 : 0.15, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + decay);

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(time);
            osc.stop(time + decay);
        }

        function schedule() {
            while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
                const stepIdx = currentStep % 16;
                const state = scoreData[stepIdx];
                
                playSynth(nextNoteTime, state);

                // 視覺同步
                const visualDelay = (nextNoteTime - audioCtx.currentTime) * 1000;
                const captureIdx = stepIdx;
                setTimeout(() => {
                    if (!isPlaying) return;
                    const steps = document.querySelectorAll('.step');
                    steps.forEach(s => s.classList.remove('playing'));
                    steps[captureIdx].classList.add('playing');
                }, visualDelay);

                nextNoteTime += (60.0 / bpm) / 4; // 1/16 音符
                currentStep++;
            }
        }

        timerWorker.onmessage = (e) => {
            if (e.data === "tick") schedule();
        };

        playBtn.onclick = () => {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            isPlaying = !isPlaying;
            if (isPlaying) {
                currentStep = 0;
                nextNoteTime = audioCtx.currentTime;
                timerWorker.postMessage("start");
                playBtn.textContent = "停止播放";
                playBtn.classList.add("stop");
            } else {
                timerWorker.postMessage("stop");
                playBtn.textContent = "播放練習";
                playBtn.classList.remove("stop");
                document.querySelectorAll('.step').forEach(s => s.classList.remove('playing'));
            }
        };

        bpmSlider.oninput = () => {
            bpm = bpmSlider.value;
            bpmText.textContent = bpm;
        };

        clearBtn.onclick = () => {
            scoreData.fill(0);
            document.querySelectorAll('.step').forEach(s => s.classList.remove('strong', 'weak'));
        };

        initGrid();
    </script>
</body>
</html>