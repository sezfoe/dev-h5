<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>鼓譜編輯器 - 跨平台自適應版</title>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --primary: #10b981;
            --accent-ui: #f43f5e;
            --text: #f8fafc;
            --focus: #3b82f6;
            --box-size: 80px; 
            --measure-border: #94a3b8; 
        }
        /* 手機端調整變數 */
        @media (max-width: 768px) {
            :root {
                --box-size: 65px;
            }
        }

        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            display: flex; flex-direction: column; height: 100vh; overflow-x: hidden;
        }
        
        /* 控制列自適應換行 */
        .controls {
            padding: 10px 15px; background: var(--panel);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            position: sticky; top: 0; z-index: 100;
            flex-wrap: wrap; gap: 10px;
        }
        .actions { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .control-group { display: flex; align-items: center; gap: 6px; }
        
        select {
            background: #334155; color: white; border: 1px solid #475569;
            padding: 5px 8px; border-radius: 6px; outline: none; cursor: pointer; font-size: 14px;
        }

        .random-options {
            display: flex; gap: 2px; background: #334155; padding: 3px; border-radius: 8px; border: 1px solid #475569;
            overflow-x: auto;
        }
        .random-chip {
            padding: 4px 8px; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: bold;
            color: #94a3b8; transition: all 0.2s; user-select: none; white-space: nowrap;
        }
        .random-chip.selected {
            background: var(--focus); color: white;
        }

        .btn-play {
            background: var(--primary); color: white; border: none;
            padding: 8px 16px; border-radius: 8px; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; gap: 8px;
            transition: all 0.2s; min-width: 70px; justify-content: center;
        }
        .btn-play.playing { background: var(--accent-ui); }

        .btn-random {
            background: #6366f1; color: white; border: none;
            padding: 8px 12px; border-radius: 8px; font-weight: bold;
            cursor: pointer; transition: all 0.2s; font-size: 13px;
        }

        /* 核心內容區：支援水平滾動以應對小螢幕 */
        .main-content {
            flex-grow: 1; display: flex; flex-direction: column;
            align-items: center; padding: 20px 10px;
            overflow-x: auto; /* 重要：手機端可左右滑動看完整樂句 */
            -webkit-overflow-scrolling: touch;
        }
        
        .editor-row { 
            display: flex; align-items: center; gap: 10px; margin-bottom: 20px; 
            min-width: max-content; /* 確保內容不會被擠壓縮 */
        }
        .editor-row.playing-row .row-label { color: var(--primary); transform: scale(1.1); }
        
        .row-label { width: 35px; font-weight: bold; color: #94a3b8; font-size: 0.85rem; text-align: center; }
        
        .editor-strip {
            display: flex; gap: 0; background: #fff; padding: 10px;
            border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            position: relative;
        }

        #countInOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.7); border-radius: 8px;
            display: none; align-items: center; justify-content: center;
            z-index: 50; color: #fff; font-size: 2.5rem; font-weight: 900;
            pointer-events: none; text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }

        .measure {
            display: flex; flex-direction: column; gap: 5px; 
            border-right: 2px solid var(--measure-border); 
            padding: 0 10px; position: relative;
        }
        .measure:first-child { padding-left: 0; }
        .measure:last-child { border-right: none; padding-right: 0; }
        .measure-beats { display: flex; gap: 8px; }
        .beat-info { font-size: 10px; color: #94a3b8; text-align: left; margin-bottom: 4px; font-weight: 800; }

        .beat-box {
            width: var(--box-size); height: var(--box-size); background: #f8fafc;
            border: 2px solid #e2e8f0; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.1s; position: relative;
            touch-action: manipulation; /* 優化觸控 */
        }
        .beat-box.active { border-color: var(--focus); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .beat-box.playing-now { background: rgba(16, 185, 129, 0.2) !important; border-color: var(--primary) !important; }
        
        canvas { max-width: 100%; max-height: 100%; }

        .row-actions { display: flex; gap: 5px; align-items: center; width: 30px; }
        .btn-remove {
            width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--accent-ui);
            background: transparent; color: var(--accent-ui); font-size: 1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }

        .btn-add {
            width: 45px; height: 45px; border-radius: 50%; border: 2px dashed #475569;
            background: transparent; color: #475569; font-size: 1.5rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; margin: 10px 0 30px 0;
        }

        /* 腳註響應式 */
        .instruction-footer {
            background: var(--panel); border-top: 1px solid #475569; padding: 20px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px; width: 100%; box-sizing: border-box;
        }
        .instruction-item { font-size: 0.8rem; color: #cbd5e1; line-height: 1.5; }
        .instruction-item h4 { margin: 0 0 8px 0; color: var(--primary); font-size: 0.85rem; }
        kbd { background: #0f172a; border: 1px solid #475569; border-radius: 4px; padding: 1px 5px; font-family: monospace; color: #fff; }

    </style>
</head>
<body>

    <div class="controls">
        <div style="font-size: 1rem; font-weight: 800; letter-spacing: 1px;">DRUM BEAT <span style="color:var(--primary)">SEQ</span></div>
        <div class="actions">
            <div class="control-group">
                <select id="soundSelect">
                    <option value="snap" selected>Snap</option>
                    <option value="noise">Noise</option>
                </select>
                <select id="accentSoundSelect">
                    <option value="snap">Snap</option>
                    <option value="noise" selected>Noise</option>
                </select>
            </div>
            <div class="control-group">
                <div class="random-options" id="randomOptionsContainer">
                    <div class="random-chip selected" data-value="1">1</div>
                    <div class="random-chip" data-value="2">2</div>
                    <div class="random-chip" data-value="3">3</div>
                    <div class="random-chip" data-value="4">4</div>
                    <div class="random-chip" data-value="5">5</div>
                    <div class="random-chip" data-value="6">6</div>
                    <div class="random-chip" data-value="7">7</div>
                    <div class="random-chip" data-value="8">8</div>
                </div>
                <button id="randomFillBtn" class="btn-random">隨機</button>
            </div>
            <div class="control-group">
                <span style="font-size: 0.8rem; white-space: nowrap;">BPM: <strong id="bpmValue">120</strong></span>
                <input type="range" id="bpmSlider" min="40" max="220" step="5" value="120" style="width: 60px; accent-color: var(--primary);">
            </div>
            <button id="playBtn" class="btn-play">播放</button>
        </div>
    </div>

    <div class="main-content">
        <div id="rowsContainer">
            <!-- 動態生成行 -->
        </div>
        <button class="btn-add" id="addRowBtn">+</button>
    </div>

    <div class="instruction-footer">
        <div class="instruction-item">
            <h4>基礎操作</h4>
            <div>空白鍵：播放/停止。上下左右切換格點。</div>
            <div>數字鍵 1-8：切換不同節奏類型。</div>
        </div>
        <div class="instruction-item">
            <h4>行動裝置</h4>
            <div>本編輯器支援水平捲動，您可以左右滑動以編輯後面的小節。</div>
        </div>
    </div>

    <script>
        const workerCode = `let t=null;self.onmessage=(e)=>{if(e.data==="start")t=setInterval(()=>postMessage("tick"),25);else if(e.data==="stop")clearInterval(t);};`;
        const blob = new Blob([workerCode], { type: 'application/javascript' });
        const timerWorker = new Worker(URL.createObjectURL(blob));

        let audioCtx = null, isPlaying = false, nextNoteTime = 0.0, currentGlobalStep = 0;
        let isCountingIn = false, countInStep = 0;

        const rowsContainer = document.getElementById('rowsContainer'), addRowBtn = document.getElementById('addRowBtn');
        const playBtn = document.getElementById('playBtn'), bpmSlider = document.getElementById('bpmSlider'), bpmValue = document.getElementById('bpmValue');
        const soundSelect = document.getElementById('soundSelect'), accentSoundSelect = document.getElementById('accentSoundSelect');
        const randomOptionsContainer = document.getElementById('randomOptionsContainer'), randomFillBtn = document.getElementById('randomFillBtn');
        const totalBeats = 16, maxRows = 16; 
        
        const SERIES_MAP = {
            1: [11], 2: [21, 22, 23], 3: [31, 32, 33, 34], 4: [41, 42, 43, 44, 45],
            5: [51, 52, 53, 54, 55], 6: [61, 62, 63, 64], 7: [71, 72, 73, 74, 75], 8: [81, 82, 83, 84, 85]
        };

        let focusState = { row: 0, beat: 0 };
        let scoreData = [new Array(totalBeats).fill(0)];

        function initApp() {
            renderRows();
            initRandomToggles();
            bpmSlider.oninput = (e) => { bpmValue.textContent = e.target.value; };
            addRowBtn.onclick = () => { 
                if (scoreData.length < maxRows) { 
                    scoreData.push(new Array(totalBeats).fill(0)); 
                    renderRows(); 
                } 
            };
            playBtn.onclick = togglePlayback;
            randomFillBtn.onclick = handleRandomFill;
        }

        function initRandomToggles() {
            randomOptionsContainer.querySelectorAll('.random-chip').forEach(chip => {
                chip.onclick = () => { chip.classList.toggle('selected'); };
            });
        }

        function handleRandomFill() {
            const selectedSeries = Array.from(randomOptionsContainer.querySelectorAll('.random-chip.selected'))
                                        .map(chip => chip.getAttribute('data-value'));
            if (selectedSeries.length === 0) return;
            let pool = []; 
            selectedSeries.forEach(s => { pool = pool.concat(SERIES_MAP[s]); });
            scoreData.forEach((rowData) => {
                for (let i = 0; i < totalBeats; i++) {
                    rowData[i] = pool[Math.floor(Math.random() * pool.length)];
                }
            });
            renderRows();
        }

        async function togglePlayback() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            
            if (!isPlaying) {
                isPlaying = true;
                isCountingIn = true;
                countInStep = 0; 
                currentGlobalStep = 0; 
                nextNoteTime = audioCtx.currentTime + 0.1;
                const overlay = document.getElementById('countInOverlay');
                if (overlay) overlay.style.display = 'flex';
                timerWorker.postMessage("start");
                playBtn.classList.add('playing'); playBtn.textContent = "停止";
            } else {
                stopPlayback();
            }
        }

        function stopPlayback() {
            isPlaying = false;
            isCountingIn = false;
            timerWorker.postMessage("stop");
            playBtn.classList.remove('playing'); 
            playBtn.textContent = "播放"; 
            const overlay = document.getElementById('countInOverlay');
            if (overlay) overlay.style.display = 'none';
            clearPlaybackUI();
            resetRowStyles();
        }

        function clearPlaybackUI() {
            document.querySelectorAll('.beat-box').forEach(el => el.classList.remove('playing-now'));
        }

        function resetRowStyles() {
            document.querySelectorAll('.editor-row').forEach(row => { row.classList.remove('playing-row'); });
        }

        timerWorker.onmessage = (e) => {
            if (e.data === "tick") {
                if (!isPlaying) return;
                const bpm = parseInt(bpmSlider.value), beatDur = 60.0 / bpm;
                while (nextNoteTime < audioCtx.currentTime + 0.1) {
                    if (isCountingIn) {
                        if (countInStep < 4) {
                            scheduleCountIn(countInStep, nextNoteTime);
                            countInStep++;
                        } else {
                            isCountingIn = false;
                            updateCountInUI(null);
                            processSequenceStep(beatDur);
                        }
                    } else {
                        processSequenceStep(beatDur);
                    }
                    nextNoteTime += beatDur; 
                }
            }
        };

        function processSequenceStep(dur) {
            const totalStepsInSequence = totalBeats * scoreData.length;
            if (currentGlobalStep >= totalStepsInSequence) { stopPlayback(); return; }
            const currentRowIndex = Math.floor(currentGlobalStep / totalBeats);
            const currentBeatInRow = currentGlobalStep % totalBeats;
            scheduleStep(currentRowIndex, currentBeatInRow, nextNoteTime, dur);
            currentGlobalStep++;
        }

        function scheduleCountIn(step, time) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(1200, time);
            gain.gain.setValueAtTime(0.4, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(time); osc.stop(time + 0.1);
            
            const countText = (4 - step).toString();
            const delay = (time - audioCtx.currentTime) * 1000;
            setTimeout(() => { 
                if (isCountingIn && isPlaying) updateCountInUI(countText); 
            }, Math.max(0, delay));
        }

        function updateCountInUI(text) {
            const overlay = document.getElementById('countInOverlay');
            if (!overlay) return;
            if (text === null) { 
                overlay.style.display = 'none'; 
            } else { 
                overlay.style.display = 'flex'; 
                overlay.textContent = text; 
            }
        }

        function playSound(time, freq, volume = 0.3, soundType = 'snap', isAccent = false) {
            const finalVol = isAccent ? volume * 1.6 : volume;
            const finalFreq = isAccent ? freq * 1.2 : freq;
            if (soundType === 'noise') {
                const bufferSize = audioCtx.sampleRate * 0.1;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noiseSource = audioCtx.createBufferSource();
                noiseSource.buffer = buffer;
                const gainNode = audioCtx.createGain();
                const noiseFilter = audioCtx.createBiquadFilter();
                noiseFilter.type = 'highpass'; noiseFilter.frequency.value = finalFreq * 3;
                noiseSource.connect(noiseFilter); noiseFilter.connect(gainNode);
                gainNode.gain.setValueAtTime(finalVol * 0.4, time);
                gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.08);
                noiseSource.start(time); noiseSource.stop(time + 0.1);
                gainNode.connect(audioCtx.destination);
                return;
            }
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.type = 'square'; osc.frequency.setValueAtTime(finalFreq * 2, time);
            gainNode.gain.setValueAtTime(finalVol * 0.5, time);
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            osc.start(time); osc.stop(time + 0.1);
        }

        function scheduleStep(r, b, time, dur) {
            const type = scoreData[r][b];
            updateUI(r, b, time);
            if (type === 0 || type === 12) return;
            const baseFreq = 220, p16 = [0, 0.25, 0.5, 0.75]; 
            const currentBaseSound = soundSelect.value, currentAccentSound = accentSoundSelect.value;
            const play = (t, isAcc = false) => { playSound(t, baseFreq, 0.3, isAcc ? currentAccentSound : currentBaseSound, isAcc); };
            if (type === 11) play(time);
            else if (type === 21) play(time); else if (type === 22) play(time + dur * 0.5); else if (type === 23) { play(time); play(time + dur * 0.5); }
            else if (type >= 31 && type <= 34) play(time + dur * p16[type - 31]);
            else if (type >= 41 && type <= 45) { const map = { 41:[0,1], 42:[1,2], 43:[2,3], 44:[0,3], 45:[1,3] }; map[type].forEach(idx => play(time + dur * p16[idx])); }
            else if (type >= 51 && type <= 55) { const map = { 51:[0,2,3], 52:[0,1,2], 53:[0,1,3], 54:[1,2,3], 55:[0,1,2,3] }; map[type].forEach(idx => play(time + dur * p16[idx])); }
            else if (type >= 61 && type <= 64) { const accentIdx = type - 61; p16.forEach((off, i) => play(time + dur * off, i === accentIdx)); }
            else if (type >= 71 && type <= 75) { const map = { 71:[0,1], 72:[1,2], 73:[2,3], 74:[0,3], 75:[1,3] }; p16.forEach((off, i) => play(time + dur * off, map[type].includes(i))); }
            else if (type >= 81 && type <= 85) { const map = { 81:[0,2,3], 82:[0,1,2], 83:[0,1,3], 84:[1,2,3], 85:[0,1,2,3] }; p16.forEach((off, i) => play(time + dur * off, map[type].includes(i))); }
        }

        function updateUI(r, b, time) {
            const delay = (time - audioCtx.currentTime) * 1000;
            setTimeout(() => {
                if (!isPlaying || isCountingIn) return;
                document.querySelectorAll('.editor-row').forEach((row, idx) => {
                    if (idx === r) row.classList.add('playing-row'); else row.classList.remove('playing-row');
                });
                clearPlaybackUI();
                const el = document.getElementById(`beat-${r}-${b}`);
                if (el) el.classList.add('playing-now');
            }, Math.max(0, delay));
        }

        function drawNoteHead(ctx, x, y, color = '#1e293b') {
            ctx.save(); ctx.fillStyle = color; ctx.translate(x, y); ctx.rotate(-0.25); ctx.beginPath();
            ctx.ellipse(0, 0, 5, 3.5, 0, 0, Math.PI * 2); ctx.fill(); ctx.restore();
        }
        function drawStem(ctx, x, yTop, yBot, color = '#1e293b', width = 1.5) {
            ctx.save(); ctx.strokeStyle = color; ctx.lineWidth = width;
            ctx.beginPath(); ctx.moveTo(x, yTop); ctx.lineTo(x, yBot); ctx.stroke(); ctx.restore();
        }
        function drawQuarterRest(ctx, x, y) {
            ctx.save(); ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 1.8; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            ctx.beginPath(); ctx.moveTo(x - 4, y - 10); ctx.lineTo(x + 2, y - 4); ctx.lineTo(x - 4, y + 2); ctx.lineTo(x + 2, y + 8);
            ctx.bezierCurveTo(x + 2, y + 11, x - 1, y + 12, x - 4, y + 10); ctx.stroke(); ctx.restore();
        }
        function drawAccent(ctx, x, y) {
            ctx.save(); ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            ctx.beginPath(); ctx.moveTo(x - 4, y - 3); ctx.lineTo(x + 3, y); ctx.lineTo(x - 4, y + 3); ctx.stroke(); ctx.restore();
        }

        function drawNote(ctx, type) {
            ctx.clearRect(0, 0, 80, 80); if (type === 0) return;
            const baseY = 55, stemTop = 22, center = 40, shortStemBot = 38;
            if (type === 11) { drawNoteHead(ctx, center - 4, baseY); drawStem(ctx, center + 0.5, stemTop, baseY); }
            else if (type === 12) { drawQuarterRest(ctx, center, 40); }
            else if (type >= 21 && type <= 23) { 
                const p1 = 25, p2 = 55;
                ctx.save(); ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 4;
                ctx.beginPath(); ctx.moveTo(p1+4.5, stemTop+2); ctx.lineTo(p2+4.5, stemTop+2); ctx.stroke(); ctx.restore();
                if (type === 21 || type === 23) { drawNoteHead(ctx, p1, baseY); drawStem(ctx, p1+4.5, stemTop, baseY, '#1e293b', 2); } 
                else { drawStem(ctx, p1+4.5, stemTop, shortStemBot, '#1e293b', 1.5); }
                if (type === 22 || type === 23) { drawNoteHead(ctx, p2, baseY); drawStem(ctx, p2+4.5, stemTop, baseY, '#1e293b', 2); } 
                else { drawStem(ctx, p2+4.5, stemTop, shortStemBot, '#1e293b', 1.5); }
            } else if (type >= 31) { 
                const positions = [18, 32, 46, 60]; let actives = [], accents = [];
                if (type >= 31 && type <= 34) actives = [type - 31];
                else if (type === 41) actives = [0, 1]; else if (type === 42) actives = [1, 2]; else if (type === 43) actives = [2, 3]; else if (type === 44) actives = [0, 3]; else if (type === 45) actives = [1, 3];
                else if (type === 51) actives = [0, 2, 3]; else if (type === 52) actives = [0, 1, 2]; else if (type === 53) actives = [0, 1, 3]; else if (type === 54) actives = [1, 2, 3]; else if (type === 55) actives = [0, 1, 2, 3];
                else if (type >= 61 && type <= 64) { actives = [0, 1, 2, 3]; accents = [type - 61]; }
                else if (type >= 71 && type <= 75) { actives = [0, 1, 2, 3]; if (type === 71) accents = [0, 1]; else if (type === 72) accents = [1, 2]; else if (type === 73) accents = [2, 3]; else if (type === 74) accents = [0, 3]; else if (type === 75) accents = [1, 3]; }
                else if (type >= 81 && type <= 85) { actives = [0, 1, 2, 3]; if (type === 81) accents = [0, 2, 3]; else if (type === 82) accents = [0, 1, 2]; else if (type === 83) accents = [0, 1, 3]; else if (type === 84) accents = [1, 2, 3]; else if (type === 85) accents = [0, 1, 2, 3]; }
                ctx.save(); ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 3;
                ctx.beginPath(); ctx.moveTo(positions[0]+4.5, stemTop); ctx.lineTo(positions[3]+4.5, stemTop); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(positions[0]+4.5, stemTop+6); ctx.lineTo(positions[3]+4.5, stemTop+6); ctx.stroke();
                ctx.restore();
                positions.forEach((x, i) => {
                    if (actives.includes(i)) { 
                        drawNoteHead(ctx, x, baseY); drawStem(ctx, x+4.5, stemTop, baseY, '#1e293b', 1.5); 
                        if (accents.includes(i)) drawAccent(ctx, x + 4, stemTop - 8);
                    } else { drawStem(ctx, x+4.5, stemTop, shortStemBot, '#1e293b', 1.2); }
                });
            }
        }

        function renderRows() {
            rowsContainer.innerHTML = '';
            scoreData.forEach((rowData, rowIndex) => {
                const rowDiv = document.createElement('div'); rowDiv.className = 'editor-row';
                const label = document.createElement('div'); label.className = 'row-label'; label.textContent = `L${rowIndex+1}`;
                rowDiv.appendChild(label);
                
                const strip = document.createElement('div'); strip.className = 'editor-strip';

                for (let m = 0; m < 4; m++) {
                    const measureDiv = document.createElement('div'); measureDiv.className = 'measure';
                    const info = document.createElement('div'); info.className = 'beat-info';
                    info.textContent = `B${m+1}`; measureDiv.appendChild(info);
                    const beatsRow = document.createElement('div'); beatsRow.className = 'measure-beats';
                    for (let b = 0; b < 4; b++) {
                        const beatIdx = m * 4 + b;
                        const beatBox = document.createElement('div');
                        beatBox.className = `beat-box`; 
                        if(rowIndex===focusState.row && beatIdx===focusState.beat) beatBox.classList.add('active');
                        beatBox.id = `beat-${rowIndex}-${beatIdx}`;
                        
                        if (rowIndex === 0 && beatIdx === 0) {
                            const overlay = document.createElement('div');
                            overlay.id = 'countInOverlay';
                            beatBox.appendChild(overlay);
                        }

                        const canvas = document.createElement('canvas'); canvas.width = 80; canvas.height = 80;
                        beatBox.appendChild(canvas); beatBox.onclick = () => setFocus(rowIndex, beatIdx);
                        beatsRow.appendChild(beatBox);
                        requestAnimationFrame(() => drawNote(canvas.getContext('2d'), rowData[beatIdx]));
                    }
                    measureDiv.appendChild(beatsRow);
                    strip.appendChild(measureDiv);
                }
                rowDiv.appendChild(strip);
                
                const actions = document.createElement('div'); actions.className = 'row-actions';
                if (scoreData.length > 1) {
                    const rm = document.createElement('button'); rm.className = 'btn-remove'; rm.textContent = '×';
                    rm.onclick = () => { scoreData.splice(rowIndex,1); renderRows(); };
                    actions.appendChild(rm);
                }
                rowDiv.appendChild(actions);
                rowsContainer.appendChild(rowDiv);
            });
        }

        function setFocus(r, b) {
            r = (r + scoreData.length) % scoreData.length;
            b = (b + totalBeats) % totalBeats;
            focusState = { row: r, beat: b };
            renderRows();
        }

        window.onkeydown = (e) => {
            if (e.code === 'Space') { e.preventDefault(); togglePlayback(); return; }
            if (!scoreData[focusState.row]) return;
            const cur = scoreData[focusState.row][focusState.beat];
            let val = -1;
            if (e.key === '1') val = (cur === 11) ? 12 : 11;
            else if (e.key === '2') { if (cur === 21) val = 22; else if (cur === 22) val = 23; else val = 21; }
            else if (e.key === '3') { if (cur >= 31 && cur < 34) val = cur + 1; else val = 31; }
            else if (e.key === '4') { if (cur >= 41 && cur < 45) val = cur + 1; else val = 41; }
            else if (e.key === '5') { if (cur >= 51 && cur < 55) val = cur + 1; else val = 51; }
            else if (e.key === '6') { if (cur >= 61 && cur < 64) val = cur + 1; else val = 61; }
            else if (e.key === '7') { if (cur >= 71 && cur < 75) val = cur + 1; else val = 71; }
            else if (e.key === '8') { if (cur >= 81 && cur < 85) val = cur + 1; else val = 81; }
            else if (e.key === 'Escape' || e.key === 'Backspace') val = 0;
            if (val !== -1) { scoreData[focusState.row][focusState.beat] = val; renderRows(); }
            if (e.key === 'ArrowRight') { e.preventDefault(); setFocus(focusState.row, focusState.beat + 1); }
            if (e.key === 'ArrowLeft') { e.preventDefault(); setFocus(focusState.row, focusState.beat - 1); }
            if (e.key === 'ArrowUp') { e.preventDefault(); setFocus(focusState.row - 1, focusState.beat); }
            if (e.key === 'ArrowDown') { e.preventDefault(); setFocus(focusState.row + 1, focusState.beat); }
        };

        initApp();
    </script>
</body>
</html>